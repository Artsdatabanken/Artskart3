trigger:
  branches:
    include:
      - develop

pool:
  vmImage: 'ubuntu-latest'

steps:

# ---------------------------
# Backend (.NET)
# ---------------------------

- task: UseDotNet@2
  displayName: "Install .NET SDK"
  inputs:
    packageType: 'sdk'
    version: '10.x'

- task: DotNetCoreCLI@2
  displayName: "Restore .NET dependencies"
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  displayName: "Build .NET solution"
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  displayName: "Run .NET tests"
  inputs:
    command: 'test'
    projects: '**/*Tests.csproj'
    arguments: '--configuration Release --no-build'

- task: DotNetCoreCLI@2
  displayName: "Publish .NET backend"
  inputs:
    command: 'publish'
    publishWebProjects: true
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)/backend'
    zipAfterPublish: true

- publish: $(Build.ArtifactStagingDirectory)/backend
  displayName: "Publish backend artifact"
  artifact: backend


# ---------------------------
# Frontend (Angular)
# ---------------------------

- task: NodeTool@0
  displayName: "Install Node.js"
  inputs:
    versionSpec: '22.14'

- script: |
    npm install -g @angular/cli
  displayName: "Install Angular CLI"

- script: |
    cd ClientApp
    npm install
  displayName: "Install Angular dependencies"

- script: |
    cd ClientApp
    npm run build -- --configuration production
  displayName: "Build Angular app"

- script: |
    cd ClientApp
    npm test -- --watch=false --browsers=ChromeHeadless
  displayName: "Run Angular tests"

- publish: ClientApp/dist
  displayName: "Publish frontend artifact"
  artifact: frontend



